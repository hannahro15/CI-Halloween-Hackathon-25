{% extends 'base.html' %}
{% load static %}

{% block title %}{{ user.username }}'s Profile{% endblock %}

{% block extra_header %}
<link rel="stylesheet" href="{% static 'css/index.css' %}">
<link rel="stylesheet" href="{% static 'css/cardstyle.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<main class="container-fluid p-0 halloween-home">
    <section class="container text-center py-5 text-light">
        <h1 class="display-3 spooky-text mb-3">{{ profile.user.username }}'s  Spooky Sanctuary</h1>
        <h2 class="mb-3 fst-italic">Adopted Familiars</h2>
        <div class="profile-card-grid" id="profileCats"></div>

        <div class="cat-profile-group" id="cat-group"></div>

        {% if adopted_cats|length == 0 %}
            <h3 class="text-center text-muted mt-4">No adopted cats yet. </h3>
        {% endif %}
    </section>
</main>
{% endblock %}


{% block extra_scripts %}
<script>
    try {
        // Safe JSON parsing with fallback
        let cats = [];
        const catsJson = JSON.parse('{{ adopted_cats_json|escapejs }}');

        console.log('=== PROFILE DEBUG ===');
        console.log('Parsed JSON from Django:', catsJson);

        if (catsJson && catsJson.length > 0) {
            cats = catsJson;
        } else {
            console.log('No cats data or empty JSON');
        }

        const container = document.getElementById("profileCats");
        console.log('Container found:', !!container);

        if (!container) {
            throw new Error('Profile cats container not found');
        }



    // Same card colors as cardscript.js
    const cardColors = [
        "#ac85b2",
        "#ff6f40",
        "#a7ac21",
        "#fc9a99",
        "#fdbe70",
        "#ff7f00",
        "#cab2d6",
    ];

    function buildCatProfile(cat) {
        const catProfiles = document.getElementById("cat-group");
        const section = document.createElement('div');
        section.className = `cat-profile`;
        section.id = `${cat.name}-profile`;

        // Image
        const img = document.createElement('img');
        if (cat.image_url) {
            img.src = cat.image_url;
        } else {
            img.src = "{% static 'images/placeholder.png' %}";
        }
        img.alt = cat.name;
        img.className = 'cat-profile-image';
        section.appendChild(img);

        // Cat Title
        const h3 = document.createElement('h3');
        h3.textContent = cat.name;
        section.appendChild(h3);

        // Cat Speciality
        const pSpecial = document.createElement('p');
        pSpecial.textContent = `Speciality: ${cat.speciality || ''}`;
        section.appendChild(pSpecial);

        // Cat breed
        const pBreed = document.createElement('p');
        pBreed.textContent = `Breed: ${cat.breed || ''}`;
        section.appendChild(pBreed);

        // Cat Biography
        const pBio = document.createElement('p');
        pBio.textContent = `${cat.biography || ''}`;
        section.appendChild(pBio);

        catProfiles.setAttribute("data-cat-id", cat.id);
        catProfiles.appendChild(section);
        return catProfiles;

    }

    // Reused same buildCard function from cardscript.js
    function buildCard(cat) {
        const card = document.createElement('div');
        card.className = 'swipe-card';

        const cardColourNum = cat.id % cardColors.length;
        card.style.backgroundColor = cardColors[cardColourNum];

        const content = document.createElement('div');
        content.className = 'card-content';

        // Image
        const img = document.createElement('img');
        if (cat.image_url) {
            img.src = cat.image_url;
        } else {
            img.src = "{% static 'images/placeholder.png' %}";
        }
        img.alt = cat.name;
        img.className = 'card-image';
        content.appendChild(img);

        // Cat Title
        const h3 = document.createElement('h3');
        h3.className = 'card-title m-0 p-0';
        h3.textContent = cat.name;
        content.appendChild(h3);

        // Cat Speciality
        const pSpecial = document.createElement('p');
        pSpecial.className = 'card-speciality m-0 p-0';
        pSpecial.textContent = cat.speciality || '';
        content.appendChild(pSpecial);

        // Cat Biography
        const pBio = document.createElement('p');
        pBio.className = 'card-bio m-0 p-0';
        pBio.textContent = cat.biography || '';
        content.appendChild(pBio);

        card.setAttribute("data-cat-id", cat.id);
        card.appendChild(content);
        return card;
    }

    // Build and display all cards
    console.log('DEBUG: Cats data received:', cats);
    console.log('DEBUG: Number of cats:', cats.length);
    
    if (cats && cats.length > 0) {
        cats.forEach(cat => {
            console.log('DEBUG: Building profile for cat:', cat.name);
            const catProfile = buildCatProfile(cat);
            container.appendChild(catProfile);
        });
        console.log('DEBUG: All profiles added to container');
    } else {
        console.log('DEBUG: No cats to display');
    }
    
    } catch (error) {
        console.error('Error in profile page:', error);
    }
</script>
{% endblock %}
